#include "dbms_functions.h"
#define _CRT_SECURE_NO_WARNINGS

time_t StringToDate(const std::string& dateStr) {
    std::tm tm = {};
    std::istringstream ss(dateStr);
    ss >> std::get_time(&tm, "%d-%m-%Y");
    return mktime(&tm);
}

std::string DateToString(time_t date) {
    std::tm tm;
    gmtime_s(&tm, &date); // Использование gmtime_s
    char buffer[80];
    strftime(buffer, 80, "%d-%m-%Y", &tm);
    return std::string(buffer);
}

void LumberDataEntry(LumberData* (&ld), int& n)
{
    Product product_;
    RawMaterial raw_material_;
    Sale sale_;
    Supplier supplier_;
    DeferredSale deferred_sale_;

    cout << "Введите размер массива: ";
    cin >> n;

    ld = new LumberData[n];

    for (int i = 0; i < n; i++)
    {
        string date;
        cout << "Ведите через пробел название продукта, тип сырья и количество: ";
        cin >> product_.name >> product_.type.name >> product_.quantity;

        cout << "Ведите через пробел название сырья и количество: ";
        cin >> raw_material_.name >> raw_material_.quantity;

        cout << "Ведите через пробел название проданого продукта, тип сырья, дату и количество: ";
        //cin >> sale_.product.name >> sale_.product.type.name >> sale_.sale_date >> sale_.quantity_sold;
        cin >> sale_.product.name >> sale_.product.type.name >> date >> sale_.quantity_sold;
        sale_.sale_date = StringToDate(date);

        cout << "Ведите название поставщика: ";
        cin >> supplier_.name;
        cout << "Ведите количество позиций поставляемого товара данным поставщиком: ";
        cin >> supplier_.num_of_pos;
        supplier_.materials.clear();
        cout << "Ведите поставляемый " << supplier_.name << " материал: " << endl;
        for (int i = 0; i < supplier_.num_of_pos; i++)
        {
            RawMaterial rm;
            cout << "Введите название материала поставляемый "  << supplier_.name << ": ";
            cin >> rm.name;
            cout << "Введите количество материала поставляемый " << supplier_.name << ": ";
            cin >> rm.quantity;
            supplier_.materials.push_back(rm);
        }
        //while (true) {
        //    cout << "Введите название материала или 'q' для выхода: ";
        //    getline(cin, input);
        //    if (input == "q") break; // Прерывание цикла при вводе 'q'

        //    
        //    RawMaterial rm;
        //    rm.name = input;

        //    cout << "Введите количество: ";
        //    cin >> rm.quantity;
        //    cin.ignore(); // Очистка буфера ввода от символа новой строки

        //    supplier_.materials.push_back(rm);
        //}
        
        cout << "Ведите через пробел название продукта отложеной продажи, тип сырья, дата, количество и причина: ";
        cin >> deferred_sale_.sale.product.name >> deferred_sale_.sale.product.type.name 
            //>> deferred_sale_.sale.sale_date >> deferred_sale_.sale.quantity_sold 
            >> date >> deferred_sale_.sale.quantity_sold
            >> deferred_sale_.reason;
        deferred_sale_.sale.sale_date = StringToDate(date);
        ld[i].LumberDataEntry(product_, raw_material_, sale_, supplier_, deferred_sale_);

        cout << "____________________________________________________________________\n";
    }
}

void LumberDataReading(LumberData* (&ld), int& n, string filename)
{
    ifstream reading(filename);

    if (reading)
    {
        Product product_;
        RawMaterial raw_material_;
        Sale sale_;
        Supplier supplier_;
        DeferredSale deferred_sale_;

        reading >> n;

        ld = new LumberData[n];

        for (int i = 0; i < n; i++)
        {
            string date;
            reading >> product_.name >> product_.type.name >> product_.quantity;
            reading >> raw_material_.name >> raw_material_.quantity;
            //reading >> sale_.product.name >> sale_.product.type.name >> sale_.sale_date >> sale_.quantity_sold;
            reading >> sale_.product.name >> sale_.product.type.name >> date >> sale_.quantity_sold;
            sale_.sale_date = StringToDate(date);
            reading >> supplier_.name;
            reading >> supplier_.num_of_pos;
            supplier_.materials.clear();
            for (int i = 0; i < supplier_.num_of_pos; i++)
            {
                RawMaterial rm;
                reading >> rm.name;
                reading >> rm.quantity;
                supplier_.materials.push_back(rm);
            }
            reading >> deferred_sale_.sale.product.name >> deferred_sale_.sale.product.type.name
                    //>> deferred_sale_.sale.sale_date >> deferred_sale_.sale.quantity_sold
                    >> date >> deferred_sale_.sale.quantity_sold
                    >> deferred_sale_.reason;
            deferred_sale_.sale.sale_date = StringToDate(date);
            ld[i].LumberDataEntry(product_, raw_material_, sale_, supplier_, deferred_sale_);
        }

        cout << "Данные считаны!" << endl;
    }
    else
    {
        cout << "Ошибка открытия файла!" << endl;
    }

    reading.close();
}

void Print(LumberData* ld, int n)
{
    for (int i = 0; i < n; i++)
    {
        cout << "Данные №" << i + 1 << endl;

        ld[i].Print();
        cout << "_______________________________________________________\n";
    }
}

void LumberDataChange(LumberData* ld, int n)
{
    Product product_;
    RawMaterial raw_material_;
    Sale sale_;
    Supplier supplier_;
    DeferredSale deferred_sale_;
    int _n;

    cout << "Выедите номер нужного элемента (от 1 до " << n << "): ";
    cin >> _n;
    _n--;

    if (_n >= 0 && _n < n)
    {
        cout << "Введите через пробел новое название продукта, тип сырья и количество: ";
        cin >> product_.name >> product_.type.name >> product_.quantity;

        cout << "Ведите через пробел новое название сырья и количество: ";
        cin >> raw_material_.name >> raw_material_.quantity;

        cout << "Ведите через пробел название проданого продукта, тип сырья, дату и количество: ";
        cin >> sale_.product.name >> sale_.product.type.name >> sale_.sale_date >> sale_.quantity_sold;

        cout << "Ведите новое название поставщика: ";
        cin >> supplier_.name;
        cout << "Ведите количество позиций поставляемого товара данным поставщиком: ";
        cin >> supplier_.num_of_pos;
        supplier_.materials.clear();
        ld[_n].GetSupplier().materials.clear();
        cout << "Ведите поставляемый " << supplier_.name << " материал: " << endl;
        for (int i = 0; i < supplier_.num_of_pos; i++)
        {
            RawMaterial rm;
            cout << "Введите название материала поставляемый " << supplier_.name << ": ";
            cin >> rm.name;
            cout << "Введите количество материала поставляемый " << supplier_.name << ": ";
            cin >> rm.quantity;
            supplier_.materials.push_back(rm);
        }

        cout << "Ведите через пробел новое название продукта отложеной продажи, тип сырья, дата, количество и причина: ";
        cin >> deferred_sale_.sale.product.name >> deferred_sale_.sale.product.type.name
            >> deferred_sale_.sale.sale_date >> deferred_sale_.sale.quantity_sold
            >> deferred_sale_.reason;
        ld[_n].LumberDataEntry(product_, raw_material_, sale_, supplier_, deferred_sale_);
    }
    else
    {
        cout << "Номер введен не верно!" << endl;
    }
}

void Copy(LumberData* d_n, LumberData* d_o, int n)
{
    for (int i = 0; i < n; i++)
    {
        d_n[i] = d_o[i];
    }
}

void AddLumberData(LumberData* (&ld), int& n)
{
    Product product_;
    RawMaterial raw_material_;
    Sale sale_;
    Supplier supplier_;
    DeferredSale deferred_sale_;
    LumberData* buf = new LumberData[n];
    int size = n, new_size = ++n;

    Copy(buf, ld, size);

    ld = new LumberData[new_size];

    Copy(ld, buf, size);

    cout << "Введите через пробел новое название продукта, тип сырья и количество: ";
    cin >> product_.name >> product_.type.name >> product_.quantity;

    cout << "Ведите через пробел новое название сырья и количество: ";
    cin >> raw_material_.name >> raw_material_.quantity;

    cout << "Ведите через пробел название проданого продукта, тип сырья, дату и количество: ";
    cin >> sale_.product.name >> sale_.product.type.name >> sale_.sale_date >> sale_.quantity_sold;

    cout << "Ведите новое название поставщика: ";
    cin >> supplier_.name;
    cout << "Ведите количество позиций поставляемого товара данным поставщиком: ";
    cin >> supplier_.num_of_pos;
    supplier_.materials.clear();
    cout << "Ведите поставляемый " << supplier_.name << " материал: " << endl;
    for (int i = 0; i < supplier_.num_of_pos; i++)
    {
        RawMaterial rm;
        cout << "Введите название материала поставляемый " << supplier_.name << ": ";
        cin >> rm.name;
        cout << "Введите количество материала поставляемый " << supplier_.name << ": ";
        cin >> rm.quantity;
        supplier_.materials.push_back(rm);
    }

    cout << "Ведите через пробел новое название продукта отложеной продажи, тип сырья, дата, количество и причина: ";
    cin >> deferred_sale_.sale.product.name >> deferred_sale_.sale.product.type.name
        >> deferred_sale_.sale.sale_date >> deferred_sale_.sale.quantity_sold
        >> deferred_sale_.reason;
    ld[size].LumberDataEntry(product_, raw_material_, sale_, supplier_, deferred_sale_);

    cout << "Данные добавлены!" << endl;

    delete[] buf;
}

void DeleteLumberData(LumberData* (&ld), int& n)
{
    int _n;
    LumberData* buf = new LumberData[n];
    cout << "Выедите номер нужного элемента (от 1 до " << n << "): ";
    cin >> _n;
    _n--;

    if (_n >= 0 && _n < n)
    {
        Copy(buf, ld, n);
        int q = 0;
        n--;

        ld = new LumberData[n];

        for (int i = 0; i <= n; i++)
        {
            if (i != _n)
            {
                ld[q] = buf[i];
                q++;
            }
        }

        cout << "Данные удалены!" << endl;
    }
    else
    {
        cout << "Номер введен не верно!" << endl;
    }

    delete[] buf;
}

void SortingLumberData(LumberData* ld, int n)
{
    LumberData buf;
    int numOfSorted = 0;

    for (int i = 0; i < n; i++)
    {
        for (int j = i + 1; j < n; j++)
        {
            if (ld[i].GetProduct().name > ld[j].GetProduct().name)
            {/*
                buf = ld[i];
                ld[i].GetSupplier().materials.clear();
                ld[i] = ld[j];
                ld[j].GetSupplier().materials.clear();
                ld[j] = buf;*/
                
                // Variant 2
                Supplier tempSupplierI = ld[i].GetSupplier();
                Supplier tempSupplierJ = ld[j].GetSupplier();

                buf = ld[i];
                ld[i].GetSupplier().materials.clear();
                ld[i] = ld[j];
                ld[i].GetSupplier().materials = tempSupplierJ.materials;

                ld[j].GetSupplier().materials.clear();
                ld[j] = buf;
                ld[j].GetSupplier().materials = tempSupplierI.materials;

                numOfSorted++;
            } 
        }
    }

    cout << "Данные отсортированы!\nКоличество сортировок: " << numOfSorted << endl;
}

void SaveLumberData(LumberData* ld, int n, string filename)
{
    ofstream record(filename);

    if (record)
    {
        record << n << endl;

        for (int i = 0; i < n; i++)
        {
            record << ld[i].GetProduct().name << " " << ld[i].GetProduct().type.name << " " << ld[i].GetProduct().quantity << endl;
            record << ld[i].GetRawMaterial().name << " " << ld[i].GetRawMaterial().quantity << endl;
            //record << ld[i].GetSale().product.name << " " << ld[i].GetSale().product.type.name << " " << ld[i].GetSale().sale_date << " " << ld[i].GetSale().quantity_sold << endl;
            record << ld[i].GetSale().product.name << " " << ld[i].GetSale().product.type.name << " " << DateToString(ld[i].GetSale().sale_date) << " " << ld[i].GetSale().quantity_sold << endl;
            record << ld[i].GetSupplier().name << endl;
            record << ld[i].GetSupplier().num_of_pos << endl;
            for (auto & it : ld[i].GetSupplier().materials)
            {
                record << it.name << " " << it.quantity << endl;
            }
            record << ld[i].GetDeferredSale().sale.product.name << " " << ld[i].GetDeferredSale().sale.product.type.name << " "
                //<< ld[i].GetDeferredSale().sale.sale_date << " " << ld[i].GetDeferredSale().sale.quantity_sold << " "
                << DateToString(ld[i].GetDeferredSale().sale.sale_date) << " " << ld[i].GetDeferredSale().sale.quantity_sold << " "
                << ld[i].GetDeferredSale().reason;

            if (i < n -1)
            {
                record << endl;
            }
        }
    }
    else
    {
        cout << "Ошибка открытия файла!" << endl;
    }

    cout << "Данные сохранены в файл!" << endl;

    record.close();
}


