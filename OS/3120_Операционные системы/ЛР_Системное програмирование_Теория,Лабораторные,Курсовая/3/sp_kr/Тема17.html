<html>

<head>
<title>Методические указания к выполнению курсовых работ по курсу "Системное програмирование"</title>
</head>

<body bgcolor=#F5DEB3 leftmargin="0" topmargin="0" rightmargin="0" bottommargin="0" marginwidth="0">
<center>
<table border="3">
<tr>
<td width="700"> <font color="#0000FF">
<h2><center>17.Хранитель экрана (Screen Saver).</center></h2>
<p align="justify">&nbsp&nbsp&nbspРазработать хранитель экрана, работающий в фоновом режиме 
и запускающийся во время длительного простоя компьютера. Программа должна отображать 
некоторый трехмерный объект (можно использовать средства OpenGL) хаотично перемещающийся в 
пределах видимого окна. Программа должна позволять устанавливать линейные размеры объекта и 
скорость его перемещения.</p>
</td>
<tr>
<td bgcolor="#FFFAFA" width="700"><center><h3><font color="#00008B"></font></h3></center>   

<p align="justify">Наш хранитель экрана будет работать в фоновом режиме, при этом он не должен мешать работе других приложений, и потреблять минимум рессурсов. Технически хранитель экрана является обычным исполняемым файлом Windows (*.exe), переименованным в *.scr, полностью управляемый сообщениями Windows.<br>
При разработке примера использовалась среда Microsoft Visual C++. Для уменьшения объема исполняемого файла в описанной программе не используется библиотека высокого уровня MFC или CLX(VCL), вся работа выполняется только средствами Win32 API. Также не используются объектно-ориентированные расширения языка. В результате удается уменьшить размер программы до 36.8K.</p>

<p align="justify">Для создания хранителей экрана в комплект Visual C++ входит заголовочный файл srcnsave.h (D:Program FilesMicrosoft Visual StudioVC98Includescrnsave.h), в котором находятся определения констант и функций на все случаи жизни, необходимых для функционирования screensaver'а в среде Windows 9x/NT, и статическая библиотека scrnsave.lib. Точка входа в программу (функция WinMain) находится в самой scrnsave.lib, что очень сильно облегчает нам жизнь. Наш хранитель пишется ориентировочно для Windows NT, хотя должен работать на всех платформах. Различие состоит в том, что для Windows 9x приходится писать еще одну функцию, отвечающую за смену пароля. В NT и выше эту роль выполняет системный процесс Winlogon. Если ключ HKEY_CURRENT_USERControl PanelDesktopScreenSaverIsSecure в системном реестре Windows не равен нулю, то Winlogon будет запрашивать пароль перед выходом из скринсейвера. Хотя без этой функции можно и обойтись.</p>

<p align="justify">Итак, приступим к написанию самого кода. Загружаем среду Visual C++. Создаем проект "Win32 Application" (File->New->Projects->Win32 Application). В Project Name вводим ssaver, в Location выбираем папку где будет хранится наш проект). Жмем Ok. Появится окошко "Win32 Application - Step 1 of 1. Оставляем все без изменений, жмем Fisnish. Ок. Имеем пустой проект. Добавляем новый файл исходного кода в проект (меню File->New->Files->C++ source files). В File name пишем ssaver, жмем Ок. Имеем файл ssaver.cpp. Перед Вами откроется пустое окно, в котором, собственно и будет писаться программа. Настраиваем среду. В меню Build->Set active configuration выбираем "ssaver - Win32 Release", ок. Подключаем бибилиотеку scrnsave.lib к проекту: меню Project->Settings, вкладка Link. Здесь в строке "Object library/modules" перечислены библиотеки, подключаемые по умолчанию к Вашему проекту, нам надо дописать scrnsave.lib:</p>

<center><img src="picture17.1.jpg" width="298" height="281" /></center>

<p align="justify">Для работы хранителя необходимо написать всего 3 функции (фактически только одну):</p>

<ul>
	<li>LRESULT WINAPI ScreenSaverProc (HWND hWnd, UINT message, WPARAM wParam, LPARAM lParam); - является "функцией окна" хранителя. Она получает все сообщения системы (аналог функции WinMain в чистом Windows-приложении). Первый параметр hWnd - идентефикатор окна нашего хранителя. message - код сообщения, которое получил хранитель от системы, wParam и lParam - параметры сообщения. В данной функции программист должен перехватить все интересующие его сообщения, а неперехваченные передать на обработку функции LRESULT WINAPI DefScreenSaverProc (HWND hWnd, UINT msg, WPARAM wParam, LPARAM lParam);</li>
	<li>BOOL WINAPI ScreenSaverConfigureDialog (HWND hDlg, UINT message, WPARAM wParam, LPARAM lParam); - функция вызывается системой всякий раз когда пользователь нажимает кнопку "настройка..." в окне настройки хранителей экрана (Пуск->Настройка->Панель управления->Экран->Заставка).</li>
	<li>BOOL WINAPI RegisterDialogClasses (HANDLE hInst); - вызывается системой для регистрации в ней дополнительных классов (мы ее не будем использовать).</li>
</ul>

<p align="justify">Итак, в новом ранее созданном окне пишем следующий код:</p>

<p>
<tt>
#include<br>
#include<br>
<br>
LRESULT WINAPI ScreenSaverProc (HWND hWnd, UINT message, WPARAM wParam, LPARAM lParam)<br>
{<br>
return 0;<br>
}<br>
<br>
BOOL WINAPI ScreenSaverConfigureDialog (HWND hDlg, UINT message, WPARAM wParam, LPARAM lParam)<br>
{<br>
return true;<br>
}<br>
<br>
BOOL WINAPI RegisterDialogClasses (HANDLE hInst)<br>
{<br>
return true;<br>
}<br>
</tt>
</p>

<p align="justify">В первых двух строках подключаются заголовочные файлы с прототипами функций (windows.h - объявления Win32 API, scrnsave.h - функции для работы с хранителем экрана). Далее объявляются 3 основных функции, которые и обеспечивают работу хранителя экрана. Сейчас у нас ScreenSaverProc ничего не делает (будем постепенно ее наращивать). Так как мы не используем никаких специальных настроек, то вторая функция тоже пуста. Нам не нужно создавать дополнительных системных классов, поэтому третья функция должна возвратить true. Жмем F7, среда Visual C++ скомпилирует программу и если не было ошибок, мы получим полноценный хранитель экрана, правда он у нас пока ничего не делает. Зайдите в папку с Вашим проектом, а затем в папку Release. Переименуйте ssaver.exe в ssaver.scr. Теперь поместите ssaver.scr в системную папку Windows (В NT/2000 это C:WINNTSystem32, в 9x С:WINDOWSSYSTEM). Зайдите на панель управления, запустите апплет "экран", дальше вкладка "заставка". В списке появится наш хранитель под именем aver (если файл начинается с "ss", то эти две буквы не показываются):</p>

<center><img src="picture17.2.jpg" width="404" height="448"></center>

<p align="justify">При нажатии кнопки "Просмотр" ничего не происходит, так и должно быть, ведь функция ScreenSaverProc пуста. Наш хранитель запускается и тут же завершает свою работу. Давайте наполним ее каким-нибудь полезным кодом.</p>

<p align="justify">Например, в функцию ScreenSaverProc можно вписать код, рисующий два вложенных квадрата, вращающихся в противоположные стороны.</p>


</td></tr>
</table>
</center>
<br><br><font color="#0000FF"><a href="index.html">Вернуться к списку тем.</a></font>

</body>


</html>