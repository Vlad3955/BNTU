<html>

<head>
<title>Методические указания к выполнению курсовых работ по курсу "Системное програмирование"</title>
</head>

<body bgcolor=#F5DEB3 leftmargin="0" topmargin="0" rightmargin="0" bottommargin="0" marginwidth="0">
<center>
<table border="3">
<tr>
<td width="700"> <font color="#0000FF">
<h2><center>21.Протоколирование событий (Event Logging).</center></h2>
<p align="justify">&nbsp&nbsp&nbspПрограмма должна уметь создавать и просматривать различные типы событий.</p>
</td>
<tr>
<td bgcolor="#FFFAFA" width="700"><center><h3><font color="#00008B">Event Logging</font></h3></center>   

<p align="justify">
Многие приложения записывают информацию об ошибках и событиях в различные
собственные протоколы. Эти протоколы различаются форматами и поэтому с
ними неудобно работать. Windows предоставляет приложениям стандартный и
централизованный путь для записи важных программных и аппаратных событий. Этот
сервис называется - <b>Event Logging</b>. Он позволяет сохранять события
из различных источников в единственном списке, называемом протокол событий
(event log). Для просмотра протокола используется приложение Event Viewer. 
</p>

<p align="justify">
Существует пять типов событий, которые могут быть запротоколированы. Каждое
событие может принадлежать только одному типу событий. В Event Viewer эти
типы используются для определения иконки, связанной с событием.
</p>

<table border="0" width="100%" cellpadding="5">
<tr bgcolor="#d0d0d0">
  <td width="20%"><b>Значение</b></td>
  <td width="80%"><b>Описание</b></td>
</tr>
<tr valign="top">
  <td>Information</td>
  <td align="justify">
    Операция выполнена успешно.
  </td>
</tr>
<tr valign="top">
  <td>Warning</td>
  <td align="justify">
    Предупреждает, что в ходе выполнения операции возникла проблема, но она
    не требует немедленного вмешательства, хотя в будущем может привести
    к серьезным сбоям.
  </td>
</tr>
<tr valign="top">
  <td>Error</td>
  <td align="justify">
    Сообщает об значительных проблемах. События типа Error обычно отражают
    потерю функциональности или данных.
  </td>
</tr>
<tr valign="top">
  <td>Success audit</td>
  <td align="justify">
    Событие системы защиты. Информирует, что операция, требующая прав доступа,
    выполнена успешна.
  </td>
</tr>
<tr valign="top">
  <td>Failure audit</td>
  <td align="justify">
    Сбой получения прав на выполнение операции.
  </td>
</tr>
</table>

<p align="justify">
Поскольку протокол событий является общедоступным сервисом, то вы должны
подумать какие сообщения записывать в него. Рекомендуется сохранять в нем
сообщения, которые могут оказаться полезными при решении аппаратных или
программных проблем. Не рекомендуется его использовать в качестве инструмента
для трассировки. Сообщение должно содержать полную и понятную информацию,
необходимую, для определения ситуации, вызвавшей проблему и что необходимо
сделать, чтобы эту проблему исправить.
<br><br>
В тексте сообщений не используйтесимволы табуляция и запятая.
<br><br>
При использовании UNC имен, или других ссылок, которые содержат пробелы,
заключайте имя в угловые скобки. Например:
<br>
<\\sharename\servername>.
<br><br>
Незабывайте, протоколирование событий потребляет ресурсы компьютера - дисковое
пространство и процессорное время.
</p>

<p align="justify">
Сервис протоколирования событий использует информацию из системного
реестра, из ключа <b>EventLog</b>. Этот ключ содержит несколько подключей,
называемых logfiles. В этих logfiles содержится информация о расположении
ресурсов, необходимых сервису, когда приложение пишет или читает протокол.
По умолчанию определены протоколы <b>Application</b>, <b>System</b> и <b>
Security</b>.
<br><br>
Приложения и службы используют протокол - <b>Application</b>. Драйвера - <b>
System</b>. Система безопастности пишет события в протокол <b>Security</b>.
</p>

<p align="justify">
Записи о событиях содержат время, тип и категорию события. Каждая запись
имеет структуру <b>EVENTLOGRECORD</b>. Записи нумеруются начиная с 1. Но
если в Event Viewer установить свойство <b>Overwrite events as needed</b>,
то при достижении максимального размера файла протокола, новые записи будут
писаться поверху старых. Поэтому не факт, что самая старая запись будет
иметь номер 1. Для получения самой старой записи надо использовать функцию
<b>GetOldestEventLogRecord</b>, а для получения последующих - <b>
GetNumberOfEventLogRecords</b>.
</p>

<p align="justify">
Каждый протокол содержит подключи, называемые источниками сообщений (event
source). Источник сообщений - это обычно имя приложения или его компонента.
Приложения и службы должны регистрироваться в протоколе <b>Application</b>.
Драйверы устройств - в <b>System</b>. Источникам сообщений нельзя давать
имена, уже используемые для именование файлов протоколов. Источники сообщений
содержат следущую информацию:
</p>

<table border="0" width="100%" cellpadding="5">
<tr bgcolor="#d0d0d0">
  <td width="20%"><b>Значение</b></td>
  <td width="80%"><b>Описание</b></td>
</tr>
<tr valign="top">
  <td><b>CategoryCount</b></td>
  <td align="justify">
    Определяет количество поддерживаемых категорий событий. Тип - REG_DWORD.
  </td>
</tr>
<tr valign="top">
  <td><b>CategoryMessageFile</b></td>
  <td align="justify">
    Определяет путь к файлу категории. Этот файл должен содержать описания
    категорий. Тип - REG_EXPAND_SZ.
  </td>
</tr>
<tr valign="top">
  <td><b>DisplayNameFile</b></td>
  <td align="justify">
    <b>Windows 2000/XP:</b> указывает файл, содержащий имя источника событий.
    Это имя будет отображаться в Event Viewer. Если это значение не указано, то
    в качестве имени используется имя ключа реестра, в котором записан источник
    событий. Тип - REG_EXPAND_SZ.
  </td>
</tr>
<tr valign="top">
  <td><b>DisplayNameID</b></td>
  <td align="justify">
    <b>Windows 2000/XP:</b> Содержит числовой идентификатор строки с именем
    источника из файла, указанного в поле <b>DisplayNameFile</b>. Тип - REG_DWORD.
  </td>
</tr>
<tr valign="top">
  <td><b>EventMessageFile</b></td>
  <td align="justify">
    Указывает файл сообщений событий. В этом поле можно указать несколько файлов,
    разделенных точкой с запятой. Файл сообщений содержит строки, описывающие
    события. Тип - REG_EXPAND_SZ.
  </td>
</tr>
<tr valign="top">
  <td><b>ParameterMessageFile</b></td>
  <td align="justify">
    Указывает файл параметров сообщений. Файл параметров сообщений содержит
    параметры, которые будут вставляться в строки описаний событий. Тип -
    REG_EXPAND_SZ.
  </td>
  <tr valign="top">
<td><b>TypesSupported</b></td>
  <td align="justify">
    Комбинация поддерживаемых типов событий. Тип - REG_DWORD. Может содержать
    одно или несколько из следущих значений:
    <br>
    EVENTLOG_ERROR_TYPE<br>
    EVENTLOG_WARNING_TYPE<br>
    EVENTLOG_INFORMATION_TYPE<br>
    EVENTLOG_AUDIT_SUCCESS<br>
    EVENTLOG_AUDIT_FAILURE<br>
  </td>
</tr>
</table>

<p align="justify">
Когда приложение вызывает функцию <b>RegisterEventSource</b> или
<b>OpenEventLog</b>, для получения указателя на протокол, служба
протоколирования ищет указанное имя в реестре. Если источник с таким
именем не найден, то используется источник по умолчанию <b>Application</b>.
Но так как он не содержит файла сообщений, произойдет ошибка. Поэтому
вы должны добавить свой источник. 
</p>

<p align="justify">
Категории позволяют организовать события, таким образом Event Viewer
может их фильтровать. В каждом источнике можно определить свои собственные
категории. Категории должны быть пронумерованы последовательно начиная с 1.
Максимальное число категорий содержится в поле <b>CategoryCount</b>.
Категории могут храниться в отдельном файле или же в файле с сообщениями.
</p>

<p align="justify">
Для каждого источника сообщений определяются свои пронумерованные события и
их текстовые описания. Описания должны быть доступны понимнию обычного
пользователя. Рассмотрим формат идентификатора события.
</p>

<pre class="source">
  3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1
  1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0
 +---+-+-+-----------------------+-------------------------------+
 |Sev|C|R|     Facility          |               Code            |
 +---+-+-+-----------------------+-------------------------------+
</pre>

<p align="justify">
<b>Sev</b><br>
&nbsp;Тип события. Может принимать одно из следующих значений:<br>
&nbsp;00 - Success<br>
&nbsp;01 - Informational<br>
&nbsp;10 - Warning<br>
&nbsp;11 - Error<br>
</p>

<p align="justify">
<b>C</b><br>
&nbsp;Indicates a customer code (1) or a system code (0).
(Уж затрудняюсь складно перевести.)
</p>

<p align="justify">
<b>R</b><br>
&nbsp;Резерв.
</p>

<p align="justify">
<b>Facility</b><br>
&nbsp;Категория сообщения. Может быть FACILITY_NULL или одним из
следующих значений:<br>
&nbsp;FACILITY_ACS<br>
&nbsp;FACILITY_AAF<br>
&nbsp;FACILITY_CERT<br>
&nbsp;FACILITY_COMPLUS<br>
&nbsp;FACILITY_CONTROL<br>
&nbsp;FACILITY_DISPATCH<br>
&nbsp;FACILITY_INTERNET<br>
&nbsp;FACILITY_ITF<br>
&nbsp;FACILITY_MEDIASERVER<br>
&nbsp;FACILITY_MSMQ<br>
&nbsp;FACILITY_RPC<br>
&nbsp;FACILITY_SCARD<br>
&nbsp;FACILITY_SECURITY<br>
&nbsp;FACILITY_SETUPAPI<br>
&nbsp;FACILITY_SSPI<br>
&nbsp;FACILITY_STORAGE<br>
&nbsp;FACILITY_URT<br>
&nbsp;FACILITY_WIN32<br>
&nbsp;FACILITY_WINDOWS<br>
</p>

<p align="justify">
<b>Code</b><br>
&nbsp;Код события.
</p>

</td></tr>
</table>
</center>
<br><br><font color="#0000FF"><a href="index.html">Вернуться к списку тем.</a></font>

</body>


</html>