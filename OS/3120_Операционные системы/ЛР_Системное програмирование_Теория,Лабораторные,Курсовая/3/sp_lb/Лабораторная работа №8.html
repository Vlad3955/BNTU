<html>
<head>
<title>ЛАБОРАТОРНАЯ РАБОТА №8</title>
<link href=style.css rel=stylesheet type=text/css>
</head>
<body>
<div class="title"><A name=REF_1_C></A>ЛАБОРАТОРНАЯ РАБОТА №8</div><br>
<div class="title"><A name=REF_1_1_1></A>Синхронизация процессов и потоков</div>
<p>
<center>[<a href="Лабораторная работа №7.html">Предыдущая работа</a>][<a href="#0">Оглавление</a>][<a href="index.html">Содержание</a>]</center>
		
<br>
<br>
<div class="title">

<a name="0"></a>Оглавление</div>
		
<ol type="1">
			
<li>
<a href="#1">Цель работы</a>			
</li>
			
<li>		
<a href="#2">Синхронизация процессов и потоков</a>
</li>
			
<ul>
			
<li>				
<a href="#2_1">Необходимость использования механизма синхронизации потоков</a>
</li>
			
<li>
<a href="#2_2">Синхронизация задач с помощью критических секций</a>
</li>
<ul>


<li>
<a href="#2_2_1">Инициализация критической секции</a>
</li>

<li>
<a href="#2_2_2">Удаление критической секции</a>
</li>


<li>
<a href="#2_2_3">Вход в критическую секцию и выход из нее</a>
</li>

<li>
<a href="#2_2_4">Рекурсивный вход в критическую секцию</a>
</li>

<li>
<a href="#2_2_5">Работа задачи с несколькими критическими секциями</a>
</li>
</ul>			
<li>
<a href="#2_3">Синхронизация задач с помощью Mutexов</a>
</li>
			
<li>
<a href="#2_4">Синхронизация задач с помощью событий</a>
</li>

<ul>
<li>
<a href="#2_4_1">Создание события</a>
</li>

<li>
<a href="#2_4_2">Открытие события</a>
</li>


<li>
<a href="#2_4_3">Установка события</a>
</li>

<li>
<a href="#2_4_4">Cброс события</a>
</li>

<li>
<a href="#2_4_5">Функция PulseEvent</a>
</li>
</ul>
			
<li>
<a href="#2_5">Синхронизация с использованием семафоров</a>
</li>
<ul>

<li>
<a href="#2_5_1">Как работает семафор</a>
</li>

<li>
<a href="#2_5_2">Функции для работы с семафорами</a>
</li>
<ul>
<li>
<a href="#2_5_2_1">Создание семафора</a>
</li>

<li>
<a href="#2_5_2_2">Уничтожение семафора</a>
</li>


<li>
<a href="#2_5_2_3">Открывание семафора</a>
</li>

<li>
<a href="#2_5_2_4">Увеличение значения счетчика семафора</a>
</li>

<li>
<a href="#2_5_2_5">Уменьшение значения счетчика семафора</a>
</li>

<li>
<a href="#2_5_2_6">Определение текущего значения счетчика семафора</a>
</li>


</ul>
</ul>
</ul>

<li>
<a href="#3">Индивидуальные задания</a>			
</li>
		
</ol>
		
<br>
<br>





<p>
<a name="1"></a>
<div class="header">1. Цель работы</div>
</p>
<div class="header">1.1. Ознакомление с существующими механизмами синхронизации процессов и потоков.</div>
<div class="header">1.2. Приобретение практических навыков синхронизации.</div>
<p>
<a name="2"></a>
<div class="header">2. Синхронизация процессов и потоков</div>
<p>
<a name="2_1"></a>
<div class="header">2.1. Необходимость использования механизма синхронизации потоков</div>

<p>
В среде, позволяющей исполнять несколько потоков одновременно, очень важно синхронизировать их деятельность. Для этого в операционных системах, базирующихся на Win32, предусмотрен целый ряд синхронизирующих объектов. В данной лабораторной рассмотриваются четыре таких объекта: критические секции, объекты-мьютексы, семафоры и события. Но существуют и другие, часть из них описанные в документации.
<br>Здесь можно познакомиться с самыми разными способами применения основных синхронизирующих объектов. Во многих случаях они ведут себя почти одинаково, но различия между ними все же есть, и зачастую именно эти различия диктуют выбор того или иного объекта для конкретной задачи.
<br>Все перечисленные объекты, за исключением критических секций, принадлежат ядру. Таким образом, критические секции не управляются низкоуровневыми компонентами операционной системы, и в работе с ними описатели не используются.
<br>В общем случае поток синхронизирует себя с другим так: он засыпает, и операционная система, не выделяя ему процессорного времени, приостанавливает его выполнение. Но прежде чем заснуть, поток сообщает системе, какое особое событие должно произойти, чтобы его исполнение возобновилось. Как только указанное событие произойдет, поток вновь получит право на выделение ему процессорного времени, и все пойдет своим чередом. Таким образом, отныне выполнение потока синхронизировано с определенным событием.
<br>Для 32-битовых программ, выполняемых под Windows 95 или Windows NT, потоки выполняются асинхронно, это значит, что при выполнении одним потоком отдельной инструкции нельзя даже сказать, какая инструкция другого потока выполняется в данный момент.
<br>Данное свойство многопоточности может создать проблемы, когда два или более потоков получают доступ к таким общим ресурсам, как глобальные переменные. Рассмотрим для примера, как два потока выполняют блок кода, который наращивает на 1 глобальный счетчик, а затем печатает новое значение счетчика:
</p>

<pre><div class="code">
// глобальное объявление:
 int Count = 0;
// ...
// функция, выполняемая двумя потоками 
void SharedFunctions()
 {
  // ...
  ++Count;
  cout << Count << '\n' ;
  // ...
 }
</div></pre>


<p>
Если эта функция вызывается повторно, ожидаемым результатом является вывод последовательных целочисленных значений, начиная с 1. Однако, поскольку код выполняется двумя потоками, может сработать следующий сценарий:
<ul>
     <li>Первый поток наращивает Count; 
     <li>Первый поток приостанавливается, и второй поток получает управление; 
     <li>Второй поток инкрементирует Count и печатает новое значение; 
     <li>Первый поток снова получает управление. Затем он печатает то же значение, что напечатано вторым потоком: его значение, которое нужно было напечатать, будет пропущено.
</ul>
<br>Чтобы предотвратить этот тип ошибки, отдельные потоки должны синхронизировать свои действия. Существует множество различных ситуаций, в которых потоки необходимо синхронизировать. Во-первых, существуют такие разновидности ресурсов, которые могут не позволять одновременный доступ многим потокам, например: объекты MFC классов, графические объекты, неразделяемые файлы и неразделяемые аппаратные устройства. Кроме того, может понадобиться синхронизировать действия потока-производителя и потока-потребителя; например, если один поток записывает символы в буфер, а другой поток читает и удаляет символы из буфера, читающему потоку понадобиться ждать, пока записывающий поток добавит символ, а записывающему потоку понадобиться ждать, пока читающий поток удалит символ.
<br>Win32 API содержит множество объектов синхронизации, которые можно использовать для синхронизации действий отдельных потоков (здесь термин объект ссылается не на объект C++). Используя эти объекты, можно выполнить различные типы синхронизации: можно запретить одновременный доступ к ресурсам более чем одному потоку, можно ограничить число потоков, одновременно получающих доступ к ресурсам, можно выполнить иные типы сигнализации между потоками.
</p>
<a name="2_2"></a>
<div class="header">2.2. Синхронизация задач с помощью критических секций</div>
<p>
Критические секции являются наиболее простым средством синхронизации задач для обеспечения последовательного доступа к ресурсам. Они работают быстро, не снижая заметно производительность системы, но обладают одним существенным недостатком – их можно использовать только для синхронизации задач в рамках одного процесса. В отличие от критических секций объекты Mutex, которые будут рассмотрены позже, допускают синхронизацию задач, созданных разными процессами. Критическая секция создается как структура типа CRITICAL_SECTION:
</p>

<pre><div class="code">
CRITICAL_SECTION csWindowPaint; 
</div></pre>

<p>
Обычно эта структура располагается в области глобальных переменных, доступной всем запущенным задачам процесса. Так как каждый процесс работает в своем собственном адресном пространстве, вы не сможете передать адрес критической секции из одного процесса в другой. Именно поэтому критические секции нельзя использовать для синхронизации задач, созданных разными процессами.
<br>В файле winbase.h (который включается автоматически при включении файла windows.h) структура CRITICAL_SECTION и указатели на нее определены следующим образом:
</p>

<pre><div class="code">
typedef RTL_CRITICAL_SECTION CRITICAL_SECTION;
typedef PRTL_CRITICAL_SECTION PCRITICAL_SECTION;
typedef PRTL_CRITICAL_SECTION LPCRITICAL_SECTION;
</pre></div>

<p>
Определение недокументированной структуры RTL_CRITICAL_SECTION вы можно найти в файле winnt.h:
</p>
<pre><div class="code">
typedef struct _RTL_CRITICAL_SECTION 
 {
  PRTL_CRITICAL_SECTION_DEBUG DebugInfo;
  LONG   LockCount;     // счетчик блокировок
  LONG   RecursionCount;// счетчик рекурсий
  HANDLE OwningThread;  // идентификатор задачи, 
                        //владеющей  секцией
  HANDLE LockSemaphore; // идентификатор семафора
  DWORD  Reserved;       // зарезервировано
 } RTL_CRITICAL_SECTION, *PRTL_CRITICAL_SECTION;
</pre></div>

<p>
Нет никакой необходимости изменять поля этой структуры вручную, так как для этого есть специальные функции. Более того, только эти функции и можно использовать для работы с критическими секциями. В документации SDK также отмечено, что структуру типа CRITICAL_SECTION нельзя перемещать или копировать.
</p>

<a name="2_2_1"></a>
<div class="header">2.2.1 Инициализация критической секции</div>
<p>
Перед использованием критической секции ее необходимо проинициализировать, вызвав для этого функцию InitializeCriticalSection:
</p>

<pre><div class="code">
CRITICAL_SECTION csWindowPaint; 
InitializeCriticalSection (&csWindowPaint);
</div></pre>

<p>Функция InitializeCriticalSection имеет только один параметр (адрес структуры типа CRITICAL_SECTION) и не возвращает никакого значения.
</p>

<a name="2_2_2"></a>
<div class="header">2.2.2 Удаление критической секции</div>
<p>
Если критическая секция больше не нужна, ее нужно удалить при помощи функции DeleteCriticalSection, как это показано ниже:
</p>

<pre><div class="code">
DeleteCriticalSection (&csWindowPaint);
</div></pre>

<p>
При этом освобождаются все ресурсы, созданные операционной системой для критической секции.
</p>
<a name="2_2_3"></a>
<div class="header">2.2.3 Вход в критическую секцию и выход из нее</div>
<p>
Две основные операции, выполняемые задачами над критическими секциями, это вход в критическую секцию и выход из критической секции. Первая операция выполняется при помощи функции EnterCriticalSection, вторая – при помощи функции LeaveCriticalSection. Эти функции, не возвращающие никакого значения, всегда используются в паре, как это показано в следующем фрагменте исходного текста:
</p>
<pre><div class="code">
EnterCriticalSection (&csWindowPaint);
 hdc = BeginPaint(hWnd, &ps);
 GetClientRect(hWnd, &rc);
DrawText(hdc, "SDI Window", -1, &rc, 
  DT_SINGLELINE | DT_CENTER | DT_VCENTER);
EndPaint(hWnd, &ps);
LeaveCriticalSection (&csWindowPaint);
</div></pre>
<p>
В качестве единственного параметра функциям EnterCriticalSection и LeaveCriticalSection необходимо передать адрес структуры типа CRITICAL_SECTION, проинициализированной предварительно функцией InitializeCriticalSection.
<br>Если одна задача вошла в критическую секцию, но еще не вышла ее, то при попытке других задач войти в ту же самую критическую секцию они будут переведены в состояние ожидания. Задачи пробудут в этом состоянии до тех пор, пока задача, которая вошла в критическую секцию, не выйдет из нее.
<br>Таким образом гарантируется, что фрагмент кода, заключенный между вызовами функций EnterCriticalSection и LeaveCriticalSection, будет выполняться задачами последовательно, если все они работают с одной и той же критической секцией.
</p>

<a name="2_2_4"></a>
<div class="header">2.2.4 Рекурсивный вход в критическую секцию</div>

<p>
Операционная система Microsoft Windows NT допускает рекурсивный вход в критическую секцию. Например, приведенный выше фрагмент кода можно было бы составить следующим образом:
</p>

<pre><div class="code">
EnterCriticalSection (&csWindowPaint);
PaintClient(hWnd);
LeaveCriticalSection (&csWindowPaint);
. . .  
void PaintClient(HWND hWnd)
 {
  . . .
  EnterCriticalSection (&csWindowPaint);
  hdc = BeginPaint(hWnd, &ps);
  GetClientRect(hWnd, &rc);
  DrawText (hdc, "SDI Window", -1, &rc, 
  DT_SINGLELINE | DT_CENTER | DT_VCENTER);
  EndPaint(hWnd, &ps);
  LeaveCriticalSection (&csWindowPaint);
 }
</div></pre>

<p>
Здесь выполняетеся вызов функции PaintClient, находясь в критической секции csWindowPaint. При этом сама функция PaintClient также пользуется той же критической секцией.
<br>Рекурсивный вход задачи в ту же самую критическую секцию не приводит к тому, что задача переходит в состояние ожидания. Однако для освобождения критической секции необходимо вызывать функцию LeaveCriticalSection столько же раз, сколько раз вызывается функция EnterCriticalSection.
</p>
<a name="2_2_5"></a>
<div class="header">2.2.5 Работа задачи с несколькими критическими секциями</div>

<p>
В том случае, когда задача работает с двумя ресурсами, доступ к которым должен выполняться последовательно, она может создать несколько критических секций. Эти секции выполняют синхронизацию главной задачи приложения с задачами, создаваемыми для окон.
<br>Заметим, что когда задачи работают с несколькими критическими секциями, все они должны использовать одинаковую последовательность входа в эти критические секции и выхода из них, иначе возможны взаимные блокировки задач.
<br>Пусть, например, в приложении определены две критические секции, синхронизирующие рисование в двух окнах:
</p>

<pre><div class="code">
CRITICAL_SECTION csWindowOnePaint; 
CRITICAL_SECTION csWindowTwoPaint; 
</div></pre>

<p>
Пусть первая задача выполняет рисование в этих окнах следующим образом:
</p>
<pre><div class="code">
EnterCriticalSection(&csWindowOnePaint);
EnterCriticalSection(&csWindowTwoPaint);
PaintClientWindow(hWndOne);
PaintClientWindow(hWndTwo);
LeaveCriticalSection(&csWindowTwoPaint);
LeaveCriticalSection(&csWindowOnePaint);
</div></pre>

<p>
Пусть вторая задача использует другой порядок входа в критические секции и выхода из них:
</p>
<pre><div class="code">
EnterCriticalSection(&csWindowTwoPaint);
EnterCriticalSection(&csWindowOnePaint);
PaintClientWindow(hWndOne);
PaintClientWindow(hWndTwo);
LeaveCriticalSection(&csWindowOnePaint);
LeaveCriticalSection(&csWindowTwoPaint);
</div></pre>
<p>При этом есть вероятность того что когда первая задача войдет в критическую секцию csWindowOnePaint, управление будет передано второй задаче, которая войдет в критическую секцию csWindowTwoPaint и перейдет в состояние ожидания. Она будет ждать освобождения критической секции csWindowOnePaint, занятой первой задачей. Однако первая задача тоже перейдет в состояние ожидания, так как ей нужна критическая секция csWindowTwoPaint, занятая второй задачей. В результате обе задачи навсегда останутся в состоянии ожидания, так как они не смогут освободить критические секции, нужные друг другу.
<br>Если нет необходимости выполнять рисование во втором окне сразу после рисования в первом окне, возможно избежать взаимной блокировки задач не только используя правильную последовательность входа и выхода в критические секции, но и выполняя последовательное использование этих критических секций:
</p>
<pre><div class="code">
// Рисование в первом окне
EnterCriticalSection (&csWindowOnePaint);
PaintClientWindow(hWndOne);
LeaveCriticalSection (&csWindowOnePaint);

// Рисование во втором окне
EnterCriticalSection (&csWindowTwoPaint);
PaintClientWindow(hWndTwo);
LeaveCriticalSection (&csWindowTwoPaint);
</div></pre>
<a name="2_3"></a>
<div class="header">2.3 Синхронизация задач с помощью Mutexов</div>
<p>
Простейшим и наиболее типичным объектом синхронизации является взаимное исключение (mutex). Имя этого объекта синхронизации происходит из выражения mutual exclusion (взаимное исключение). Он используется для ограничения доступа к данному ресурсу единственным потоком в одно время.
<br>При использовании взаимного исключения первый шаг должен вызывать функцию Win32 API CreateMutex, чтобы создать синхронизирующий объект взаимное исключение (это может сделать любой поток программы).
</p>
<pre><div class="code">
HANDLE CreateMutex(
  LPSECURITY_ATTRIBUTES lpMutexAttributes,
  BOOL bInitialOwner,
  LPCTSTR lpName);
</div></pre>

<p>Первый параметр описывает атрибуты прав доступа взаимного исключения; передача значения NULL присваивает ему эти атрибуты по умолчанию и делает управление взаимным исключением ненаследуемым. Второй параметр описывает начальное состояние взаимного исключения, передача FALSE создает взаимное исключение, которое изначально свободно (если передать TRUE, взаимное исключение изначально занято). Третий параметр задает имя взаимного исключения; передача NULL создаетnt.
<br>В операционной системе Microsoft Windows не предусмотрено средств, с помощью которых можно было бы определить текущее значение семафора, не изменяя его. В частности, вы не можете задать функции ReleaseSemaphore нулевое значение инкремента, так как в этом случае указанная функция просто вернет соответствующий код ошибки.
</p>

<a name="3"></a>
<div class="header">3. Индивидуальные задания</div>

<p>
Находятся в файле <a href="Индивидуальные задания_08.html" target="_blank">« Индивидуальные задания »</a>
</p>
<center>[<a href="Лабораторная работа №7.html">Предыдущая работа</a>][<a href="#0">Оглавление</a>][<a href="index.html">Содержание</a>]</center>



</body>
</p>
</html>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                